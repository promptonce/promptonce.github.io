
<!DOCTYPE html><html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.29.0" theme-name="Stellar" theme-version="1.29.0">
  
  <meta name="generator" content="Hexo 7.2.0">
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000">
  <meta name="theme-color" content="#f9fafb">
  
  <title>MMSegmentation基本概念-模型 - PromptOnce</title>

  
    <meta name="description" content="ModelsWe usually define a neural network in a deep learning task as a model, and this model is the core of an algorithm. MMEngine abstracts a unified model BaseModel to standardize the interfaces for">
<meta property="og:type" content="article">
<meta property="og:title" content="MMSegmentation基本概念-模型">
<meta property="og:url" content="https://promptonce.github.io/2024/08/23/MMSegmentation%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5-%E6%A8%A1%E5%9E%8B/index.html">
<meta property="og:site_name" content="PromptOnce">
<meta property="og:description" content="ModelsWe usually define a neural network in a deep learning task as a model, and this model is the core of an algorithm. MMEngine abstracts a unified model BaseModel to standardize the interfaces for">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-08-23T14:54:22.000Z">
<meta property="article:modified_time" content="2024-08-23T14:54:30.000Z">
<meta property="article:author" content="penggan">
<meta property="article:tag" content="MMSegmentation">
<meta name="twitter:card" content="summary">
  
  
  
  <meta name="keywords" content="MMSegmentation">

  <!-- feed -->
  
    <link rel="alternate" href="/atom.xml" title="PromptOnce" type="application/atom+xml">
  

  <link rel="stylesheet" href="/css/main.css?v=1.29.0">

  

  

  
</head>
<body>

<div class="l_body s:aa content tech" id="start" layout="post" ><aside class="l_left"><div class="leftbar-container">


<header class="header"><div class="logo-wrap"><a class="avatar" href="/about/"><div class="bg" style="opacity:0;background-image:url(https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/rainbow64@3x.webp);"></div><img no-lazy class="avatar" src="undefined" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></a><a class="title" href="/"><div class="main" ff="title">PromptOnce</div></a></div></header>

<div class="nav-area">
<div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" placeholder="站内搜索"></form><div id="search-result"></div><div class="search-no-result">没有找到内容！</div></div>


<nav class="menu dis-select"></nav>
</div>
<div class="widgets">


<widget class="widget-wrapper post-list"><div class="widget-header dis-select"><span class="name">最近更新</span></div><div class="widget-body fs14"><a class="item title" href="/2024/12/25/AI%E5%8F%AA%E8%83%BD%E6%88%90%E4%B8%BACopilot-%E5%89%AF%E9%A9%BE%E9%A9%B6/"><span class="title">AI只能成为Copilot-副驾驶</span></a><a class="item title" href="/2024/12/21/Vue3%E4%B8%AD%E7%9A%84ref%E5%92%8Creactive%E6%80%BB%E7%BB%93/"><span class="title">Vue3中的ref和reactive总结</span></a><a class="item title" href="/2024/12/21/Vue-3%E7%BB%84%E5%90%88%E5%BC%8FAPI%E4%B8%AD%E7%9A%84%E7%8A%B6%E6%80%81%E4%B8%8E%E6%96%B9%E6%B3%95%E7%AE%A1%E7%90%86%EF%BC%9A%E4%B8%8D%E4%BB%85%E4%BB%85%E6%98%AF%E5%B1%9E%E6%80%A7/"><span class="title">Vue 3组合式API中的状态与方法管理：不仅仅是属性</span></a><a class="item title" href="/2024/12/21/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E4%B8%AD%E7%9A%84%E7%89%B9%E5%BE%81%E5%9B%BE%E4%B8%8E%E6%B3%A8%E6%84%8F%E5%8A%9B%E5%9B%BE%EF%BC%9A%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90%E4%B8%8E%E5%AF%B9%E6%AF%94/"><span class="title">深度学习中的特征图与注意力图：全面解析与对比</span></a><a class="item title" href="/2024/12/16/%E7%94%A8%E5%B0%91%E6%95%B0%E9%AB%98%E6%95%88%E6%8C%87%E6%A0%87%E5%BF%AB%E9%80%9F%E9%AA%8C%E8%AF%81%E5%BC%80%E5%8F%91%E5%B7%A5%E4%BD%9C%E7%9A%84%E6%AD%A3%E7%A1%AE%E6%80%A7/"><span class="title">用少数高效指标快速验证开发工作的正确性</span></a><a class="item title" href="/2024/12/15/%E7%A8%8B%E5%BA%8F%E5%91%98%E5%A6%82%E4%BD%95%E5%85%A8%E9%9D%A2%E5%88%86%E6%9E%90%E8%BD%AF%E4%BB%B6%E4%BA%A7%E5%93%81%EF%BC%9A%E4%BC%98%E7%82%B9%E4%B8%8E%E7%BC%BA%E7%82%B9/"><span class="title">程序员如何全面分析软件产品：优点与缺点</span></a><a class="item title" href="/2024/12/15/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88Windows-Server%EF%BC%89%E4%B8%8E%E6%9C%AC%E5%9C%B0PC%EF%BC%88Windows%EF%BC%89%E7%9A%84%E5%AF%B9%E6%AF%94%EF%BC%9A%E7%A8%8B%E5%BA%8F%E5%91%98%E8%A7%86%E8%A7%92/"><span class="title">云服务器（Windows Server）与本地PC（Windows）的对比：程序员视角</span></a><a class="item title" href="/2024/12/15/%E4%B9%92%E4%B9%93%E7%90%83%EF%BC%9A%E9%94%BB%E7%82%BC%E5%A4%A7%E8%84%91%E6%95%8F%E9%94%90%E6%80%A7%E7%9A%84%E9%87%8D%E8%A6%81%E8%BF%90%E5%8A%A8/"><span class="title">乒乓球：锻炼大脑敏锐性的重要运动</span></a><a class="item title" href="/2024/12/15/%E7%A8%8B%E5%BA%8F%E5%91%98%E5%A6%82%E4%BD%95%E5%83%8F%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E4%B8%80%E6%A0%B7%E9%AB%98%E6%95%88%E5%AD%A6%E4%B9%A0%EF%BC%9AGPT-%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8%E4%B8%8E%E6%80%9D%E8%80%83/"><span class="title">程序员如何像神经网络一样高效学习：GPT 工具的使用与思考</span></a><a class="item title" href="/2024/12/14/%E5%85%B3%E4%BA%8E%E6%8A%80%E6%9C%AF%E5%AD%A6%E4%B9%A0%E3%80%81%E4%BB%A3%E7%A0%81%E7%BB%86%E8%8A%82%E5%92%8C%E6%8A%80%E6%9C%AF%E5%B4%87%E6%8B%9C%E7%9A%84%E8%AE%A8%E8%AE%BA/"><span class="title">关于技术学习、代码细节和技术崇拜的讨论</span></a></div></widget>
</div>

</div></aside><div class="l_main" id="main">





<div class="article banner top">
  <div class="content">
    <div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/">主页</a>
<span class="sep"></span><a class="cap breadcrumb" href="/">文章</a></div>
<div class="flex-row" id="post-meta"><span class="text created">发布于：<time datetime="2024-08-23T14:54:22.000Z">2024-08-23</time></span><span class="sep updated"></span><span class="text updated">更新于：<time datetime="2024-08-23T14:54:30.000Z">2024-08-23</time></span></div></div></div>
    
    <div class="bottom only-title">
      
      <div class="text-area">
        <h1 class="text title"><span>MMSegmentation基本概念-模型</span></h1>
        
      </div>
    </div>
    
  </div>
  </div><article class="md-text content"><h1 id="Models"><a href="#Models" class="headerlink" title="Models"></a>Models</h1><p>We usually define a neural network in a deep learning task as a model, and this model is the core of an algorithm. MMEngine abstracts a unified model BaseModel to standardize the interfaces for training, testing and other processes. All models implemented by MMSegmentation inherit from BaseModel, and in MMSegmentation we implemented forward and added some functions for the semantic segmentation algorithm. MMEngine抽象了一个统一的模型BaseModel, 目的是标准化训练，测试以及其它的流程。所有MMSegmentation实现的模型继承自BaseModel,在MMSegmentation中我们实现了前向传播和添加了一些语义分割算法的功能。</p>
<h2 id="Common-components"><a href="#Common-components" class="headerlink" title="Common components"></a>Common components</h2><h3 id="Segmentor"><a href="#Segmentor" class="headerlink" title="Segmentor"></a>Segmentor</h3><p>In MMSegmentation, we abstract the network architecture as a Segmentor, it is a model that contains all components of a network. We have already implemented EncoderDecoder and CascadeEncoderDecoder, which typically consist of Data preprocessor, Backbone, Decode head and Auxiliary head. 在MMSegmentation中，我们将网络结构抽象为一个Segmentor, 这是一个包含网络所有组件的模型。我们已经实现了EncoderDecoder和CascadeEncoderDecoder，这两者典型地由Data preprocessor, Backbonem, Decode head和Auxiliary head构成。</p>
<h3 id="Data-preprocessor"><a href="#Data-preprocessor" class="headerlink" title="Data preprocessor"></a>Data preprocessor</h3><p>Data preprocessor is the part that copies data to the target device and preprocesses the data into the model input format. 数据预处理器是将数据复制到目标设备并将数据预处理为模型输入格式的部分。</p>
<h3 id="Backbone"><a href="#Backbone" class="headerlink" title="Backbone"></a>Backbone</h3><p>Backbone is the part that transforms an image to feature maps, such as a ResNet-50 without the last fully connected layer. 主干是将图像转换为特征图的部分，例如没有最后一个完全连接层的ResNet-50。</p>
<h3 id="Neck"><a href="#Neck" class="headerlink" title="Neck"></a>Neck</h3><p>Neck is the part that connects the backbone and heads. It performs some refinements or reconfigurations on the raw feature maps produced by the backbone. An example is Feature Pyramid Network (FPN). 颈部是连接骨干和头部的部分。它对骨干生成的原始特征图进行一些细化或重新配置。一个例子是特征金字塔网络（FPN）。</p>
<h3 id="Decode-head"><a href="#Decode-head" class="headerlink" title="Decode head"></a>Decode head</h3><p>Decode head is the part that transforms the feature maps into a segmentation mask, such as PSPNet.<br>解码头是将特征映射转换为分割掩码的部分，例如PSPNet。</p>
<h3 id="Auxiliary-head"><a href="#Auxiliary-head" class="headerlink" title="Auxiliary head"></a>Auxiliary head</h3><p>Auxiliary head is an optional component that transforms the feature maps into segmentation masks which only used for computing auxiliary losses.辅助头是一个可选组件，它将特征图转换为仅用于计算辅助损失的分割掩码。</p>
<h2 id="Basic-interfaces"><a href="#Basic-interfaces" class="headerlink" title="Basic interfaces"></a>Basic interfaces</h2><p>MMSegmentation wraps BaseModel and implements the BaseSegmentor class, which mainly provides the interfaces forward, train_step, val_step and test_step. The following will introduce these interfaces in detail.</p>
<h3 id="forward"><a href="#forward" class="headerlink" title="forward"></a>forward</h3><p>The forward method returns losses or predictions of training, validation, testing, and a simple inference process. forward。函数返回训练阶段的losses或predictions</p>
<p>The method should accept three modes: “tensor”, “predict” and “loss”:</p>
<ul>
<li><p>“tensor”: Forward the whole network and return the tensor or tuple of tensor without any post-processing, same as a common nn.Module.“张量”：转发整个网络并返回张量的张量或元组，无需任何后处理，与普通的nn. Module相同。</p>
</li>
<li><p>“predict”: Forward and return the predictions, which are fully processed to a list of SegDataSample. 前向计算并返回预测，这些预测被完全处理到SegDataSample列表中。</p>
</li>
<li><p>“loss”: Forward and return a dict of losses according to the given inputs and data samples.根据给定的输入和数据样本转发和返回损失判断。</p>
</li>
</ul>
<p><strong>Note</strong>: <a target="_blank" rel="noopener" href="https://github.com/open-mmlab/mmsegmentation/blob/1.x/mmseg/structures/seg_data_sample.py">SegDataSample</a> is a data structure interface of MMSegmentation, it is used as an interface between different components. SegDataSample implements the abstract data element mmengine.structures.BaseDataElement, please refer to the [SegDataSample documentation](Note that this method doesn’t handle either backpropagation or optimizer updating, which are done in the method train_step.) and <a target="_blank" rel="noopener" href="https://mmengine.readthedocs.io/en/latest/advanced_tutorials/data_element.html">data element documentation</a> in <a target="_blank" rel="noopener" href="https://github.com/open-mmlab/mmengine">MMEngine</a> for more information.</p>
<p>Note that this method doesn’t handle either backpropagation or optimizer updating, which are done in the method train_step.</p>
<p>Parameters:</p>
<ul>
<li><p>inputs (torch.Tensor) - The input tensor with shape (N, C, …) in general.</p>
</li>
<li><p>data_sample (list[SegDataSample]) - The seg data samples. It usually includes information such as metainfo and gt_sem_seg. Default to None.</p>
</li>
<li><p>mode (str) - Return what kind of value. Defaults to ‘tensor’.</p>
</li>
</ul>
<p>Returns:</p>
<ul>
<li><p>dict or list:</p>
</li>
<li><p>If mode &#x3D;&#x3D; “loss”, return a dict of loss tensor used for backward and logging.</p>
</li>
<li><p>If mode &#x3D;&#x3D; “predict”, return a list of SegDataSample, the inference results will be incrementally added to the data_sample parameter passed to the forward method, each SegDataSample contains the following keys:</p>
<ul>
<li><p>pred_sem_seg (PixelData): Prediction of semantic segmentation.</p>
</li>
<li><p>seg_logits (PixelData): Predicted logits of semantic segmentation before normalization.</p>
</li>
</ul>
</li>
<li><p>If mode &#x3D;&#x3D; “tensor”, return a tensor or tuple of tensor or dict of tensor for custom use.</p>
</li>
</ul>
<h2 id="prediction-modes"><a href="#prediction-modes" class="headerlink" title="prediction modes"></a>prediction modes</h2><p> We briefly describe the fields of the model’s configuration in the config documentation, here we elaborate on the model.test_cfg field. model.test_cfg is used to control forward behavior, the forward method in “predict” mode can run in two modes:</p>
<ul>
<li>whole_inference: If cfg.model.test_cfg.mode &#x3D;&#x3D; ‘whole’, model will inference with full images.</li>
</ul>
<p>An whole_inference mode example config:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">model = <span class="built_in">dict</span>(</span><br><span class="line">  <span class="built_in">type</span>=<span class="string">&#x27;EncoderDecoder&#x27;</span></span><br><span class="line">  ...</span><br><span class="line">  test_cfg=<span class="built_in">dict</span>(mode=<span class="string">&#x27;whole&#x27;</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>slide_inference: If cfg.model.test_cfg.mode &#x3D;&#x3D; ‘slide’, model will inference by sliding-window. Note: if you select the slide mode, cfg.model.test_cfg.stride and cfg.model.test_cfg.crop_size should also be specified.</p>
<p>An slide_inference mode example config:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">model = <span class="built_in">dict</span>(</span><br><span class="line">  <span class="built_in">type</span>=<span class="string">&#x27;EncoderDecoder&#x27;</span></span><br><span class="line">  ...</span><br><span class="line">  test_cfg=<span class="built_in">dict</span>(mode=<span class="string">&#x27;slide&#x27;</span>, crop_size=<span class="number">256</span>, stride=<span class="number">170</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="train-step"><a href="#train-step" class="headerlink" title="train_step"></a>train_step</h3><p>The train_step method calls the forward interface of the loss mode to get the loss dict. The BaseModel class implements the default model training process including preprocessing, model forward propagation, loss calculation, optimization, and back-propagation.</p>
<p>Parameters:</p>
<p>data (dict or tuple or list) - Data sampled from the dataset. In MMSegmentation, the data dict contains inputs and data_samples two fields.</p>
<p>optim_wrapper (OptimWrapper) - OptimWrapper instance used to update model parameters.</p>
<p>Note: OptimWrapper provides a common interface for updating parameters, please refer to optimizer wrapper documentation in MMEngine for more information.</p>
<p>Returns:</p>
<p>Dict[str, torch.Tensor]: A dict of tensor for logging.</p>
<h3 id="val-step"><a href="#val-step" class="headerlink" title="val_step"></a>val_step</h3><p>The val_step method calls the forward interface of the predict mode and returns the prediction result, which is further passed to the process interface of the evaluator and the after_val_iter interface of the Hook.</p>
<p>Parameters:</p>
<p>data (dict or tuple or list) - Data sampled from the dataset. In MMSegmentation, the data dict contains inputs and data_samples two fields.</p>
<p>Returns:</p>
<p>list - The predictions of given data.</p>
<h3 id="test-step"><a href="#test-step" class="headerlink" title="test_step"></a>test_step</h3><p>The BaseModel implements test_step the same as val_step.</p>
<h2 id="Data-Preprocessor"><a href="#Data-Preprocessor" class="headerlink" title="Data Preprocessor"></a>Data Preprocessor</h2><p>The SegDataPreProcessor implemented by MMSegmentation inherits from the BaseDataPreprocessor implemented by MMEngine and provides the functions of data preprocessing and copying data to the target device.</p>
<p>The runner carries the model to the specified device during the construction stage, while the data is carried to the specified device by the SegDataPreProcessor in train_step, val_step, and test_step, and the processed data is further passed to the model.</p>
<p>The parameters of the SegDataPreProcessor constructor:</p>
<ul>
<li><p>mean (Sequence[Number], optional) - The pixel mean of R, G, B channels. Defaults to None.</p>
</li>
<li><p>std (Sequence[Number], optional) - The pixel standard deviation of R, G, B channels. Defaults to None.</p>
</li>
<li><p>size (tuple, optional) - Fixed padding size.</p>
</li>
<li><p>size_divisor (int, optional) - The divisor of padded size.</p>
</li>
<li><p>pad_val (float, optional) - Padding value. Default: 0.</p>
</li>
<li><p>seg_pad_val (float, optional) - Padding value of segmentation map. Default: 255.</p>
</li>
<li><p>bgr_to_rgb (bool) - whether to convert image from BGR to RGB. Defaults to False.</p>
</li>
<li><p>rgb_to_bgr (bool) - whether to convert image from RGB to BGR. Defaults to False.</p>
</li>
<li><p>batch_augments (list[dict], optional) - Batch-level augmentations. Default to None.</p>
</li>
</ul>
<p>The data will be processed as follows:</p>
<ul>
<li><p>Collate and move data to the target device.</p>
</li>
<li><p>Pad inputs to the input size with defined pad_val, and pad seg map with defined seg_pad_val.</p>
</li>
<li><p>Stack inputs to batch_inputs.</p>
</li>
<li><p>Convert inputs from bgr to rgb if the shape of input is (3, H, W).</p>
</li>
<li><p>Normalize image with defined std and mean.</p>
</li>
<li><p>Do batch augmentations like Mixup and Cutmix during training.</p>
</li>
</ul>
<p>The parameters of the forward method:</p>
<ul>
<li><p>data (dict) - data sampled from dataloader.</p>
</li>
<li><p>training (bool) - Whether to enable training time augmentation.</p>
</li>
</ul>
<p>The returns of the forward method:</p>
<ul>
<li>Dict: Data in the same format as the model input.</li>
</ul>

<div class="article-footer fs14">
    <section id="license">
      <div class="header"><span>许可协议</span></div>
      <div class="body"><p>本文采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">署名-非商业性使用-相同方式共享 4.0 国际</a> 许可协议，转载请注明出处。</p>
</div>
    </section>
    </div>
</article>
<div class="related-wrap" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">较新文章</div><a href="/2024/08/25/%E8%A1%8C%E5%86%85%E5%85%83%E7%B4%A0%E5%92%8C%E5%9D%97%E7%BA%A7%E5%85%83%E7%B4%A0/">行内元素和块级元素</a></div><div class="item" id="next"><div class="note">较早文章</div><a href="/2024/08/23/MMSegmentation%E4%BB%8E0-x%E8%BF%81%E7%A7%BB%E5%88%B01-x/">MMSegmentation从0.x迁移到1.x</a></div></section></div>






<footer class="page-footer footnote"><hr><div class="text"><p>本站由 <a href="/">penggan</a> 使用 <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.29.0">Stellar 1.29.0</a> 主题创建。<br>本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处。</p>
</div></footer>
<div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right">
<div class="widgets">



<widget class="widget-wrapper toc" id="data-toc" collapse="false"><div class="widget-header dis-select"><span class="name">本文目录</span><a class="cap-action" onclick="sidebar.toggleTOC()" ><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></a></div><div class="widget-body"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Models"><span class="toc-text">Models</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Common-components"><span class="toc-text">Common components</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Segmentor"><span class="toc-text">Segmentor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Data-preprocessor"><span class="toc-text">Data preprocessor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Backbone"><span class="toc-text">Backbone</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Neck"><span class="toc-text">Neck</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Decode-head"><span class="toc-text">Decode head</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Auxiliary-head"><span class="toc-text">Auxiliary head</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Basic-interfaces"><span class="toc-text">Basic interfaces</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#forward"><span class="toc-text">forward</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#prediction-modes"><span class="toc-text">prediction modes</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#train-step"><span class="toc-text">train_step</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#val-step"><span class="toc-text">val_step</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#test-step"><span class="toc-text">test_step</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Data-Preprocessor"><span class="toc-text">Data Preprocessor</span></a></li></ol></li></ol></div><div class="widget-footer">

<a class="top" onclick="util.scrollTop()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 12c0-4.714 0-7.071 1.464-8.536C4.93 2 7.286 2 12 2c4.714 0 7.071 0 8.535 1.464C22 4.93 22 7.286 22 12c0 4.714 0 7.071-1.465 8.535C19.072 22 16.714 22 12 22s-7.071 0-8.536-1.465C2 19.072 2 16.714 2 12Z"/><path stroke-linecap="round" stroke-linejoin="round" d="m9 15.5l3-3l3 3m-6-4l3-3l3 3"/></g></svg><span>回到顶部</span></a></div></widget>
</div></aside><div class='float-panel blur'>
  <button type='button' style='display:none' class='laptop-only rightbar-toggle mobile' onclick='sidebar.rightbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg>
  </button>
  <button type='button' style='display:none' class='mobile-only leftbar-toggle mobile' onclick='sidebar.leftbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg>
  </button>
</div>
</div><div class="scripts">
<script type="text/javascript">
  const ctx = {
    date_suffix: {
      just: `刚刚`,
      min: `分钟前`,
      hour: `小时前`,
      day: `天前`,
    },
    root : `/`,
  };

  // required plugins (only load if needs)
  if (`local_search`) {
    ctx.search = {};
    ctx.search.service = `local_search`;
    if (ctx.search.service == 'local_search') {
      let service_obj = Object.assign({}, `{"field":"all","path":"/search.json","content":true,"sort":"-date"}`);
      ctx.search[ctx.search.service] = service_obj;
    }
  }
  const def = {
    avatar: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/3442075.svg`,
    cover: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/cover/76b86c0226ffd.svg`,
  };
  const deps = {
    jquery: `https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js`,
    marked: `https://cdn.bootcdn.net/ajax/libs/marked/4.0.18/marked.min.js`
  }
  

</script>

<script type="text/javascript">
  const utils = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    css: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    js: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')){
        src = ctx.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    jq: (fn) => {
      if (typeof jQuery === 'undefined') {
        utils.js(deps.jquery).then(fn)
      } else {
        fn()
      }
    },
    
    onLoading: (el) => {
      if (el) {
        $(el).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>');
      }
    },
    onLoadSuccess: (el) => {
      if (el) {
        $(el).find('.loading-wrap').remove();
      }
    },
    onLoadFailure: (el) => {
      if (el) {
        $(el).find('.loading-wrap svg').remove();
        $(el).find('.loading-wrap').append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>');
        $(el).find('.loading-wrap').addClass('error');
      }
    },
    request: (el, url, callback, onFailure) => {
      let retryTimes = 3;
      utils.onLoading(el);
      function req() {
        return new Promise((resolve, reject) => {
          let status = 0; // 0 等待 1 完成 2 超时
          let timer = setTimeout(() => {
            if (status === 0) {
              status = 2;
              timer = null;
              reject('请求超时');
              if (retryTimes == 0) {
                onFailure();
              }
            }
          }, 5000);
          fetch(url).then(function(response) {
            if (status !== 2) {
              clearTimeout(timer);
              resolve(response);
              timer = null;
              status = 1;
            }
            if (response.ok) {
              return response.json();
            }
            throw new Error('Network response was not ok.');
          }).then(function(data) {
            retryTimes = 0;
            utils.onLoadSuccess(el);
            callback(data);
          }).catch(function(error) {
            if (retryTimes > 0) {
              retryTimes -= 1;
              setTimeout(() => {
                req();
              }, 5000);
            } else {
              utils.onLoadFailure(el);
              onFailure();
            }
          });
        });
      }
      req();
    },
  };
</script>

<script>
  const sidebar = {
    leftbar: () => {
      if (l_body) {
        l_body.toggleAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    rightbar: () => {
      if (l_body) {
        l_body.toggleAttribute('rightbar');
        l_body.removeAttribute('leftbar');
      }
    },
    dismiss: () => {
      if (l_body) {
        l_body.removeAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    toggleTOC: () => {
      document.querySelector('#data-toc').classList.toggle('collapse');
    }
  }
</script>
<script type="text/javascript">
  (() => {
    const tagSwitchers = document.querySelectorAll('.tag-subtree.parent-tag > a > .tag-switcher-wrapper')
    for (const tagSwitcher of tagSwitchers) {
      tagSwitcher.addEventListener('click', (e) => {
        const parent = e.target.closest('.tag-subtree.parent-tag')
        parent.classList.toggle('expanded')
        e.preventDefault()
      })
    }

    // Get active tag from query string, then activate it.
    const urlParams = new URLSearchParams(window.location.search)
    const activeTag = urlParams.get('tag')
    if (activeTag) {
      let tag = document.querySelector(`.tag-subtree[data-tag="${activeTag}"]`)
      if (tag) {
        tag.querySelector('a').classList.add('active')
        
        while (tag) {
          tag.classList.add('expanded')
          tag = tag.parentElement.closest('.tag-subtree.parent-tag')
        }
      }
    }
  })()
</script>


<!-- required -->
<script src="/js/main.js?v=1.29.0" defer></script>

<script type="text/javascript">
  const applyTheme = (theme) => {
    if (theme === 'auto') {
      document.documentElement.removeAttribute('data-theme')
    } else {
      document.documentElement.setAttribute('data-theme', theme)
    }

    applyThemeToGiscus(theme)
  }

  const applyThemeToGiscus = (theme) => {
    theme = theme === 'auto' ? 'preferred_color_scheme' : theme

    const cmt = document.getElementById('giscus')
    if (cmt) {
      // This works before giscus load.
      cmt.setAttribute('data-theme', theme)
    }

    const iframe = document.querySelector('#comments > section.giscus > iframe')
    if (iframe) {
      // This works after giscus loaded.
      const src = iframe.src
      const newSrc = src.replace(/theme=[\w]+/, `theme=${theme}`)
      iframe.src = newSrc
    }
  }

  const switchTheme = () => {
    // light -> dark -> auto -> light -> ...
    const currentTheme = document.documentElement.getAttribute('data-theme')
    let newTheme;
    switch (currentTheme) {
      case 'light':
        newTheme = 'dark'
        break
      case 'dark':
        newTheme = 'auto'
        break
      default:
        newTheme = 'light'
    }
    applyTheme(newTheme)
    window.localStorage.setItem('Stellar.theme', newTheme)

    const messages = {
      light: `切换到浅色模式`,
      dark: `切换到深色模式`,
      auto: `切换到跟随系统配色`,
    }
    hud?.toast?.(messages[newTheme])
  }

  (() => {
    // Apply user's preferred theme, if any.
    const theme = window.localStorage.getItem('Stellar.theme')
    if (theme !== null) {
      applyTheme(theme)
    }
  })()
</script>


<!-- optional -->



<script defer>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.services = Object.assign({}, JSON.parse(`{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":null},"ghinfo":{"js":"/js/services/ghinfo.js"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"}}`));
    for (let id of Object.keys(ctx.services)) {
      const js = ctx.services[id].js;
      if (id == 'siteinfo') {
        ctx.cardlinks = document.querySelectorAll('a.link-card[cardlink]');
        if (ctx.cardlinks?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            setCardLink(ctx.cardlinks);
          });
        }
      } else {
        const els = document.getElementsByClassName(`ds-${id}`);
        if (els?.length > 0) {
          utils.jq(() => {
            if (id == 'timeline' || 'memos' || 'marked') {
              utils.js(deps.marked).then(function () {
                utils.js(js, { defer: true });
              });
            } else {
              utils.js(js, { defer: true });
            }
          });
        }
      }
    }
  });
</script>

<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.search = {
      path: `/search.json`,
    }
    utils.js('/js/search/local-search.js', { defer: true });
  });
</script><script>
  window.FPConfig = {
    delay: 0,
    ignoreKeywords: [],
    maxRPS: 5,
    hoverDelay: 25
  };
</script>
<script defer src="https://cdn.bootcdn.net/ajax/libs/flying-pages/2.1.2/flying-pages.min.js"></script><script defer src="https://cdn.bootcdn.net/ajax/libs/vanilla-lazyload/17.8.4/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazy",
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    window.lazyLoadInstance?.update();
  });
</script><script>
  ctx.fancybox = {
    selector: `.timenode p>img`,
    css: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.min.css`,
    js: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.umd.min.js`
  };
  var selector = '[data-fancybox]:not(.error)';
  if (ctx.fancybox.selector) {
    selector += `, ${ctx.fancybox.selector}`
  }
  var needFancybox = document.querySelectorAll(selector).length !== 0;
  if (!needFancybox) {
    const els = document.getElementsByClassName('ds-memos');
    if (els != undefined && els.length > 0) {
      needFancybox = true;
    }
  }
  if (needFancybox) {
    utils.css(ctx.fancybox.css);
    utils.js(ctx.fancybox.js, { defer: true }).then(function () {
      Fancybox.bind(selector, {
        hideScrollbar: false,
        Thumbs: {
          autoStart: false,
        },
        caption: (fancybox, slide) => {
          return slide.triggerEl.alt || slide.triggerEl.dataset.caption || null
        }
      });
    })
  }
</script>
<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    const swiper_api = document.getElementById('swiper-api');
    if (swiper_api != undefined) {
      utils.css(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.css`);
      utils.js(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.js`, { defer: true }).then(function () {
        const effect = swiper_api.getAttribute('effect') || '';
        var swiper = new Swiper('.swiper#swiper-api', {
          slidesPerView: 'auto',
          spaceBetween: 8,
          centeredSlides: true,
          effect: effect,
          rewind: true,
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
        });
      })
    }
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    window.codeElements = document.querySelectorAll('.code');
    if (window.codeElements.length > 0) {
      ctx.copycode = {
        default_text: `Copy`,
        success_text: `Copied`,
        toast: `复制成功`,
      };
      utils.js('/js/plugins/copycode.js');
    }
  });
</script>


<!-- inject -->

</div></body></html>
